<!doctype html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<title>Export Facebook Contacts with Android - Zach Denton</title>
		<meta name="author" content="Zach Denton">
		<meta name="description" content="How to use a rooted Android phone to export your Facebook address book.">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link href="http://fonts.googleapis.com/css?family=Cabin:400,600|Poly:400,400italic" rel="stylesheet" type="text/css">
		<link rel="stylesheet" href="../css/main.css">
		
	</head>
	<body>
		<header role="banner">
			<h1><a href="../">Zach Denton</a></h1>
			<nav>
			<ul>
				<li><a href="../about/">About</a></li>
				<li><a href="../archives/">Blog</a></li>
				<li><a href="../project-euler-solutions/">Euler</a></li>
				<li><a href="https://github.com/zacharydenton">GitHub</a></li>
				<li><a href="../resume.pdf">Resume</a></li>
			</ul>
			</nav>
			<a href="mailto:z@chdenton.com"><canvas></canvas></a>
		</header>

		<article>
  <h1>Export Facebook Contacts with Android</h1>

  <p>If you have a rooted Android phone, you have full control over your device — and unrestricted access to the data it contains. In this post, I’m going to show you how you can use your rooted Android device to do something that <a href="http://techcrunch.com/2011/02/22/google-android-facebook-contacts/">the average person can’t do</a>: namely, export your contacts from the Facebook app on Android.</p>
<h2 id="get-the-contacts-database">1. Get the contacts database</h2>
<p>It turns out that the Facebook app stores your contacts in an SQLite database located on the filesystem at <code>/data/data/com.facebook.katana/databases/fb.db</code>. In order to use this database, we need to copy it to a computer. Since Android doesn’t provide access to the internal storage via USB, I first copied the database to my SD card using a root file browser, and then copied it to my computer via USB.</p>
<h2 id="examine-the-contacts-database">2. Examine the contacts database</h2>
<p>Now that you have the database on your local machine, you can analyze it and determine its structure. Begin by opening it up with the SQLite client:</p>
<pre><code>$ sqlite3 /path/to/fb.db</code></pre>
<p>Now it’s just the standard procedure when dealing with an unknown database:</p>
<h3 id="list-the-tables">2.1 List the tables</h3>
<pre><code>sqlite&gt; .tables
albums                    friends                   page_search_results
android_metadata          friends_data              perf_sessions
cache                     key_value                 photos
chatconversations         mailbox_messages          search_results
chatmessages              mailbox_messages_display  stream_photos
connections               mailbox_profiles          user_statuses
default_page_images       mailbox_threads           user_values
events                    notifications</code></pre>
<h3 id="determine-which-tables-contain-the-data-youre-looking-for">2.2 Determine which tables contain the data you’re looking for</h3>
<p>The table’s name is often a good indicator of its contents. In this case, the <code>friends</code> table (technically, it’s a <a href="http://www.sqlite.org/lang_createview.html">view</a>) contains all the data we need.</p>
<h3 id="determine-which-columns-to-extract">2.3 Determine which columns to extract</h3>
<p>Here’s the structure of the <code>friends</code> view:</p>
<pre><code>sqlite&gt; .schema friends
CREATE VIEW friends AS SELECT connections._id AS _id, connections.user_id AS user_id, connections.display_name AS display_name, connections.connection_type AS connection_type, connections.user_image_url AS user_image_url, connections.user_image AS user_image, connections.hash AS hash, friends_data.first_name AS first_name, friends_data.last_name AS last_name, friends_data.cell AS cell, friends_data.other AS other, friends_data.email AS email, friends_data.birthday_month AS birthday_month, friends_data.birthday_day AS birthday_day, friends_data.birthday_year AS birthday_year FROM connections LEFT OUTER JOIN friends_data ON connections.user_id=friends_data.user_id WHERE connections.connection_type=0;</code></pre>
<p>In this case, the important columns are:</p>
<ul>
<li><code>display_name</code></li>
<li><code>user_image_url</code></li>
<li><code>first_name</code></li>
<li><code>last_name</code></li>
<li><code>cell</code></li>
<li><code>other</code></li>
<li><code>email</code></li>
<li><code>birthday_month</code></li>
<li><code>birthday_day</code></li>
<li><code>birthday_year</code></li>
</ul>
<p>At this point, the hard part is over and it’s just a matter of extracting the data from the database.</p>
<h2 id="export-the-data">3. Export the data</h2>
<h3 id="the-vcard-format">3.1 The vCard format</h3>
<p>Now that we know exactly which data we need, we can export it from the database into a useful format. The most useful format for contact data appears to be <a href="https://en.wikipedia.org/wiki/VCard">vCard</a>, which is almost universally supported in communication apps. I won’t go into the details of the <a href="https://tools.ietf.org/html/rfc6350">vCard specification</a>, but here’s an example of what we’re trying to generate:</p>
<pre><code>BEGIN:VCARD
VERSION:3.0
N:Feynman;Richard;;;
FN:Richard Feynman
TEL;TYPE=HOME:+72973525698
EMAIL;TYPE=PREF:rfeynman@princeton.edu
BDAY:1918-5-11
REV:2012-01-08T18:36:35.814661
END:VCARD

BEGIN:VCARD
VERSION:3.0
N:Planck;Max;;;
FN:Max Planck
TEL;TYPE=CELL:+66260695729
EMAIL;TYPE=PREF:planck@berlin.de
BDAY:1858-4-23
REV:2012-01-08T18:36:36.043204
END:VCARD</code></pre>
<p>Notice that multiple contacts can exist in the same file.</p>
<h3 id="a-script-to-generate-the-vcard">3.2 A script to generate the vCard</h3>
<p>I’ve written a Python script to generate a vCard from the <code>fb.db</code>:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">#!/usr/bin/env python</span>
<span class="ch">import</span> sys
<span class="ch">import</span> base64
<span class="ch">import</span> codecs
<span class="ch">import</span> sqlite3
<span class="ch">import</span> urllib2
<span class="ch">import</span> argparse
<span class="ch">import</span> datetime

<span class="kw">def</span> parse_database(database):
    conn = sqlite3.<span class="ot">connect</span>(database)
    conn.row_factory=sqlite3.Row
    c = conn.cursor()
    fields = <span class="st">'display_name, user_image_url, first_name, '</span> +\
             <span class="co">'last_name, cell, other, email, birthday_month, '</span> +\
             <span class="co">'birthday_day, birthday_year'</span>
    c.execute(<span class="st">'select </span><span class="ot">%s</span><span class="st"> from friends'</span> % fields)
    <span class="kw">return</span> [row <span class="kw">for</span> row in c]

<span class="kw">def</span> generate_vcard(contact, photos=<span class="ot">False</span>):
    card = <span class="st">&quot;BEGIN:VCARD</span><span class="ch">\n</span><span class="st">VERSION:3.0</span><span class="ch">\n</span><span class="st">&quot;</span>
    card += <span class="st">&quot;N:</span><span class="ot">%s</span><span class="st">;</span><span class="ot">%s</span><span class="st">;;;</span><span class="ch">\n</span><span class="st">&quot;</span> % (contact[<span class="st">'last_name'</span>], contact[<span class="st">'first_name'</span>])
    card += <span class="st">&quot;FN:</span><span class="ot">%s</span><span class="ch">\n</span><span class="st">&quot;</span> % contact[<span class="st">'display_name'</span>]

    <span class="kw">if</span> contact[<span class="st">'cell'</span>]:
        card += <span class="st">'TEL;TYPE=CELL:</span><span class="ot">%s</span><span class="ch">\n</span><span class="st">'</span> % contact[<span class="st">'cell'</span>]

    <span class="kw">if</span> contact[<span class="st">'other'</span>]:
        card += <span class="st">'TEL;TYPE=HOME:</span><span class="ot">%s</span><span class="ch">\n</span><span class="st">'</span> % contact[<span class="st">'other'</span>]

    <span class="kw">if</span> contact[<span class="st">'email'</span>]:
        card += <span class="st">&quot;EMAIL;TYPE=PREF:</span><span class="ot">%s</span><span class="ch">\n</span><span class="st">&quot;</span> % contact[<span class="st">'email'</span>]

    birthday = <span class="st">&quot;-&quot;</span>.join([<span class="dt">str</span>(f) <span class="kw">for</span> f in [contact[<span class="st">'birthday_year'</span>],
                                          contact[<span class="st">'birthday_month'</span>],
                                          contact[<span class="st">'birthday_day'</span>]]
                         <span class="kw">if</span> f != -<span class="dv">1</span>])
    <span class="kw">if</span> birthday:
        <span class="kw">if</span> birthday.count(<span class="st">'-'</span>) == <span class="dv">1</span>: birthday = <span class="st">&quot;1900-&quot;</span> + birthday <span class="co"># default year</span>
        card += <span class="st">&quot;BDAY:</span><span class="ot">%s</span><span class="ch">\n</span><span class="st">&quot;</span> % birthday

    <span class="kw">if</span> photos and contact[<span class="st">'user_image_url'</span>]:
        <span class="kw">try</span>:
            photo = urllib2.urlopen(contact[<span class="st">'user_image_url'</span>]).read()
            card += <span class="st">&quot;PHOTO;ENCODING=B;TYPE=JPEG:</span><span class="ot">%s</span><span class="ch">\n</span><span class="st">&quot;</span> %\
                    base64.b64encode(photo)
        <span class="kw">except</span>:
            <span class="kw">pass</span>


    card += <span class="st">&quot;REV:</span><span class="ot">%s</span><span class="ch">\n</span><span class="st">END:VCARD</span><span class="ch">\n</span><span class="st">&quot;</span> % datetime.datetime.now().isoformat()
    <span class="kw">return</span> card

<span class="kw">def</span> main():
    parser = argparse.ArgumentParser()
    parser.add_argument(<span class="st">'database'</span>, <span class="dt">help</span>=<span class="st">&quot;path to facebook database&quot;</span>, default=<span class="st">&quot;fb.db&quot;</span>, nargs=<span class="st">'?'</span>)
    parser.add_argument(<span class="st">'vcard'</span>, <span class="dt">help</span>=<span class="st">&quot;file to write contacts to&quot;</span>, default=<span class="st">&quot;fbcontacts.vcf&quot;</span>, nargs=<span class="st">'?'</span>)
    parser.add_argument(<span class="st">'--photos'</span>, action=<span class="st">&quot;store_true&quot;</span>, <span class="dt">help</span>=<span class="st">&quot;download profile pictures&quot;</span>)
    args = parser.parse_args()

    <span class="kw">with</span> codecs.<span class="dt">open</span>(args.vcard, <span class="st">'w'</span>, <span class="st">'utf-8'</span>) <span class="ch">as</span> vcard:
        contacts = parse_database(args.database)
        <span class="kw">for</span> i, contact in <span class="dt">enumerate</span>(contacts):
            sys.stderr.write(<span class="st">&quot;</span><span class="ch">\r</span><span class="st">exporting contact </span><span class="ot">%s</span><span class="st"> of </span><span class="ot">%s</span><span class="st">&quot;</span> % (i<span class="dv">+1</span>, <span class="dt">len</span>(contacts)))
            card = generate_vcard(contact, args.photos)
            <span class="dt">print</span> &gt;&gt; vcard, card
            sys.stderr.flush()
        sys.stderr.write(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)

<span class="kw">if</span> <span class="ot">__name__</span> == <span class="st">&quot;__main__&quot;</span>: main()</code></pre>
<p>It just goes through each row, grabs the relevant data, and writes it out in vCard format.</p>
<p>To use the script, just run <code>python fbcontacts.py /path/to/fb.db</code>. You’ll end up with all of your contacts in a vCard file, complete with email addresses, phone numbers, birthdays, and (if you specify the <code>--photos</code> flag) profile pictures.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Restrictions don’t apply to those with rooted phones and a bit of curiosity.</p>
</article>


		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
		<script src="../js/main.js"></script>
	</body>
</html>
